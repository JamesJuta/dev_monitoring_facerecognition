<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Data Table Example with Tabulator and AJAX</title>
    <link href="https://cdn.jsdelivr.net/npm/tabulator-tables@5.0.0/dist/css/tabulator.min.css" rel="stylesheet" />
    <!-- <link rel="stylesheet" href="{{ url_for('static', filename = 'css/tabulator.min.css') }}"> -->

    <link rel="stylesheet" href="{{ url_for('static', filename = 'css/bootstrap-datetimepicker.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename = 'css/daterange_picker.min.css') }}">

    
  </head>
  <body>

    
    <div class="container">
        <div class="row" style="padding: 20px 100px;">
            <div class="col-12">
                <div class="data_table">
                    <strong>Today Scan</strong>
                    <div class="form-group float-end mb-2" style="margin-left:auto;" id="DateDemo">
                        <label for="exampleDataList" class="form-label"><b>Filter by</b></label>
                        <input type="text" id="date_range" name="date_range" class="form-control  " style="width:300px;" value="{{current_date}}" placeholder="Select Date">
                    </div><br>
                    <div id="example-table"></div>
                    <div>
                        <button type="button" class="table_btn" id="download-csv">Download CSV</button>
                        <button type="button" class="table_btn" id="download-xlsx">Download XLSX</button>
                        <button type="button" class="table_btn" id="print-table">Print</button>
                    </div>
                </div>
            </div>
        </div>
    </div>


   

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="{{ url_for('static', filename = 'js/tabulator.min.js') }}"></script>
    <script src="{{ url_for('static', filename = 'js/daterangepicker.js') }}"></script>
    <script>
      var table = new Tabulator('#example-table', {
        height: "400px",
        printAsHtml: true,
        headerFilterPlaceholder: "Search",
        layout: 'fitDataStretch',
        placeholder: 'No Data Found',
        ajaxURL: '/get_data',
        ajaxParams: {
          table: 1
          //status: global_date
        },
        pagination: 'remote',
        paginationButtonCount: 5,
        paginationSize: 10,
        ajaxSorting: true,
        ajaxFiltering: true,
        ajaxLoader: true,
        ajaxLoaderLoading: 'Fetching data from Database..',
        paginationSizeSelector: [50, 100, 500, 1000, 2000],
        columns: [
                {title: "Date", field: "date", 
                    headerFilter: "input",
                    headerFilterFunc: "like",
                    headerFilterParams: {
                        allowEmpty: true
                    },
                    headerFilterLiveFilter: false,
                    formatter: 'textarea',
                    vertAlign: 'middle',
                    minWidth: 250},
                {title: "Time", field: "time", 
                    headerFilter: "input",
                    headerFilterFunc: "like",
                    headerFilterParams: {
                        allowEmpty: true
                    },
                    headerFilterLiveFilter: false,
                    formatter: 'textarea',
                    vertAlign: 'middle',
                    minWidth: 250},
                {title: "Name", field: "name", 
                    headerFilter: "input",
                    headerFilterFunc: "like",
                    headerFilterParams: {
                        allowEmpty: true
                    },
                    headerFilterLiveFilter: false,
                    formatter: 'textarea',
                    vertAlign: 'middle',
                    minWidth: 250},
                {title: "Building Name", field: "building_name", 
                    headerFilter: "input",
                    headerFilterFunc: "like",
                    headerFilterParams: {
                        allowEmpty: true
                    },
                    headerFilterLiveFilter: false,
                    formatter: 'textarea',
                    vertAlign: 'middle',
                        minWidth: 250},
            ],
        ajaxResponse: function (url, params, response) {
          return response.data
        },
      })

      (function() {
        var datetime = '{{current_datetime}}'
        var global_date = '{{current_date}}' + "@" + '{{current_date}}'
        var set_server_time = '{{current_datetime}}'
        var serverOffset = moment(set_server_time).diff(new Date());
        var now_server = moment();
        now_server.add(serverOffset, 'milliseconds');
        var dateLimit = now_server.format('MM-DD-YYYY');

        $('#date_range').daterangepicker({
            opens: 'left',
            maxDate: dateLimit
        }, function(start, end, label) {
            global_date = start.format('YYYY-MM-DD') + "@" + end.format('YYYY-MM-DD');
            table.setData("/get_data", {
                table: 'master_schedule',
                status: global_date
            });
            table.setSort([{
                    column: "date",
                    dir: "DESC"
                }, //sort by this first
            ]);
        });


        //trigger download of timelog.csv file
        document.getElementById("download-csv").addEventListener("click", function() {
            table.download("csv", "timelog_" + datetime + ".csv", {
                bom: true
            });
        });

        //trigger download of timelog.xlsx file
        document.getElementById("download-xlsx").addEventListener("click", function() {
            table.download("xlsx", "timelog_" + datetime + ".xlsx", {
                sheetName: "My Data"
            });
        });

        //trigger download of timelog.xlsx file
        document.getElementById("print-table").addEventListener("click", function() {
            table.print(false, true);
        });
    })();
    </script>
  </body>
</html>