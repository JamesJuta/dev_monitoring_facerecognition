<!DOCTYPE html>
<html lang="en">

<head>
    {% include "head.html" %}
</head>

<body class="d-flex flex-column h-100vh" style="background-color: #f5f8fe;">

    <!-- navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white sticky-top shadow p-2">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="{{ url_for('static', filename='img/e_monitoring_logo') }}" alt="" width="55" height="55" class="d-inline-block align-text-top p-1">
                <span class="navbar-brand mb-0 h1 p-1"><b>E-Monitoring</b></span>
            </a>
            <button class="navbar-toggler collapsed btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="toggler-icon top-bar"></span>
                <span class="toggler-icon middle-bar"></span>
                <span class="toggler-icon bottom-bar"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-end" id="navbarSupportedContent">
                <ul class="navbar-nav mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('home') }}"><i class='bx bx-home'></i> Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active text-primary" aria-current="page" href="{{ url_for('time_log') }}"><i class='bx bx-time'></i> Time Log</a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link" aria-current="page" href="{{ url_for('face_register_password') }}"><i class='bx bx-user' ></i> Face Register</a>
                    </li>
                    <!-- <li class="nav-item">
                        <a class="nav-link" href="#" id="showPasswordModal" data-bs-toggle="modal" data-bs-target="#faceRegisterModal"><i class='bx bx-user' ></i> Face Register</a>
                    </li> -->
                </ul>
            </div>
        </div>
    </nav>
    
    <!-- time Log Table -->
    <div class="container">
        <div class="row" style="padding: 20px;">
            <div class="col-12">
                <div class="card shadow-sm rounded-3">
                    <div class="card-header bg-primary text-white fw-semibold d-flex align-items-center justify-content-between flex-wrap" style=" height: 70px;">
                        <h4 class="p-2 text-white"><i class='bx bx-time'></i> <b>Time Log</b></h4>
                        <div class="p-2 d-flex" style="margin-left:auto;" id="DateDemo">
                            <label for="exampleDataList" class="form-label p-2 text-white"> <i class='bx bx-calendar'></i> Filter by</label>
                            <input type="text" id="date_range" name="date_range" class="form-control p-2 " style="width:200px; height: 35px;" value="{{current_date}}" placeholder="Select Date">
                        </div><br>
                    </div>
                    <div class="card-body mt-1 bg-white">
                        <div id="example-table" class="table table-sm tabulator"></div>
                        <div>
                            <button type="button" class="btn btn-outline-primary btn-sm" id="download-csv"><i class='bx bx-download'></i> Download CSV</button>
                            <button type="button" class="btn btn-outline-primary btn-sm" id="download-xlsx"><i class='bx bx-download'></i> Download XLSX</button>
                            <button type="button" class="btn btn-outline-primary btn-sm" id="print-table"><i class='bx bx-printer'></i> Print</button>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
    </div>

    {% include "password_modal.html" %}
    {% include "footer.html" %}

    <script>

        var datetime = '{{current_datetime}}'
        var global_date = '{{ initial_date_range }}';
        var set_server_time = '{{current_datetime}}'
        var serverOffset = moment(set_server_time).diff(new Date());
        var now_server = moment();
        now_server.add(serverOffset, 'milliseconds');
        var dateLimit = now_server.format('MM-DD-YYYY');

        var startDate = moment('{{current_date}}', 'MM-DD-YYYY');
        var endDate = moment('{{current_date}}', 'MM-DD-YYYY');

        $('#date_range').daterangepicker({
            opens: 'left',
            startDate: startDate,
            endDate: endDate
        }, function (start, end, label) {
            var start_date = start.format('YYYY-MM-DD');
            var end_date = end.format('YYYY-MM-DD');
            
            // Trigger table update
            table.setData("/get_data", {
                start_date: start_date,
                end_date: end_date
            });
            table.setSort([{
                column: "date",
                dir: "DESC"
            }]);
        });

        var table = new Tabulator('#example-table', {
            height: "350px",
            printAsHtml: true,
            headerFilterPlaceholder: "Search",
            layout: 'fitDataStretch',
            placeholder: 'No Data Found',
            ajaxURL: '/get_data',
            ajaxParams: {
                table: 'master_schedule',
                status: global_date
            },
            pagination: 'remote',
            paginationButtonCount: 5,
            paginationSize: 20,
            ajaxSorting: true,
            ajaxFiltering: true,
            ajaxLoader: true,
            ajaxLoaderLoading: 'Fetching data from Database..',
            paginationSizeSelector: [50, 100, 500, 1000, 2000],
            columns: [
                {title: "Date", field: "date",
                    headerFilterPlaceholder: "Search Date",
                    headerFilter: "input",
                    headerFilterFunc: "like",
                    headerFilterParams: {
                        allowEmpty: true
                    },
                    headerFilterLiveFilter: false,
                    formatter: 'textarea',
                    vertAlign: 'middle',
                    minWidth: 250},
                {title: "Time", field: "time", 
                    headerFilterPlaceholder: "Search Time",
                    headerFilter: "input",
                    headerFilterFunc: "like",
                    headerFilterParams: {
                        allowEmpty: true
                    },
                    headerFilterLiveFilter: false,
                    formatter: 'textarea',
                    vertAlign: 'middle',
                    minWidth: 250},
                {title: "Name", field: "name",
                    headerFilterPlaceholder: "Search Name",
                    headerFilter: "input",
                    headerFilterFunc: "like",
                    headerFilterParams: {
                        allowEmpty: true
                    },
                    headerFilterLiveFilter: false,
                    formatter: 'textarea',
                    vertAlign: 'middle',
                    minWidth: 250},
                {title: "Building Name", field: "building_name", 
                    headerFilterPlaceholder: "Search Building Name",
                    headerFilter: "input",
                    headerFilterFunc: "like",
                    headerFilterParams: {
                        allowEmpty: true
                    },
                    headerFilterLiveFilter: false,
                    formatter: 'textarea',
                    vertAlign: 'middle',
                        minWidth: 250},
            ],
            ajaxResponse: function (url, params, response) {
                return response.data
            },
        });
        // Trigger download of CSV file
        document.getElementById("download-csv").addEventListener("click", function () {
            table.download("csv", "timelog_" + '{{current_date}}' + ".csv", {
                bom: true
            });
        });
        // Trigger download of xlsx file
        document.getElementById("download-xlsx").addEventListener("click", function () {
            table.download("xlsx", "timelog_" + '{{current_date}}' + ".xlsx", {
                sheetName: "My Data",
            });
        });
        // Trigger print function
        document.getElementById("print-table").addEventListener("click", function () {
            table.print(false, true);
        });
    </script>
</body>

</html>