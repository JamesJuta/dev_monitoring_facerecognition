<!DOCTYPE html>
<html lang="en">
<head>
    {% include "head.html" %}
</head>
<body class="d-flex flex-column h-100vh" style="background-color: #f5f8fe;">

    <!-- navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white sticky-top shadow p-2 p-2 pe-5 ps-5">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="{{ url_for('static', filename='img/e_monitoring_logo') }}" alt="" width="55" height="55" class="d-inline-block align-text-top p-1">
                <span class="navbar-brand mb-0 h1 p-1"><b>E-Monitoring</b></span>
            </a>
            <button class="navbar-toggler collapsed btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="toggler-icon top-bar"></span>
                <span class="toggler-icon middle-bar"></span>
                <span class="toggler-icon bottom-bar"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-end" id="navbarSupportedContent">
                <ul class="navbar-nav mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active text-primary" href="{{ url_for('home') }}"><i class='bx bx-home'></i> Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" aria-current="page" href="{{ url_for('time_log') }}"><i class='bx bx-time'></i> Time Log</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" aria-current="page" href="{{ url_for('face_register_password') }}"><i class='bx bx-user' ></i> Face Register</a>
                    </li>
                    <!-- <li class="nav-item">
                        <a class="nav-link" href="#" id="showPasswordModal" data-bs-toggle="modal" data-bs-target="#faceRegisterModal"><i class='bx bx-user' ></i> Face Register</a>
                    </li> -->
                </ul>
            </div>
        </div>
    </nav>
    
    <!-- Face recognition  -->
    <div class="container">
        <div class="row" style="padding: 20px;">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white fw-semibold d-flex align-items-center justify-content-between flex-wrap" style=" height: 60px;">
                        <h4 class="p-2 text-white"><i class='bx bx-scan' ></i> <b>Face Recognition</b></h4>
                    </div>
                    <div class="card-body mt-1 bg-white d-flex " style="gap: 10px;">
                       
                        <img  class="card p-2 shadow-sm" alt="img" src="{{ url_for('video_feed') }}" width="640" height="480">

                        <div class="card p-2 shadow-sm p-4 align-items-center justify-content-center time_date_container">
                            <div class="geometric_shape mx-auto">
                                <img src="{{ url_for('static', filename='img/clock.svg') }}" width="200" alt="">
                            </div>
        
                            <h1 class="time " id="nowTime">{{ current_time }}</h1>
                            <h1 class="date " id="nowDate">{{ current_date }}</h1>
                            
                            <div class="d-flex mx-auto">
                                <label class="p-2" for="selected_date">Select Building: </label>
                                <select class=" p-2" name="optskill" id="optskill">
                                    <option value="Building 1">Building 1</option>
                                    <option value="Building 2">Building 2</option>
                                    <option value="Building 3">Building 3</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
    </div>
    
    {% include "password_modal.html" %}
    {% include "footer.html" %}

<script>
    // set server time using moment.js library
    var set_server_time = '{{ current_time }}';
    var serverOffset = moment(set_server_time).diff(new Date());
    clearInterval(clock_id);
    var date_now_server = moment();
    date_now_server.add(serverOffset, 'milliseconds');
    var dateNow = date_now_server.format('dddd | MMMM DD, YYYY');

    // Set time and date
    var clock_id = setInterval(function() {
        if (document.getElementById('nowTime')) {
            $('#nowDate').html(dateNow);
            var now_server = moment();
            now_server.add(serverOffset, 'milliseconds');
            var timeNow = now_server.format('hh:mm:ss A');
            $('#nowTime').html(timeNow);
        } else {
            clearInterval(clock_id);
        }
    }, 1000);

    $(document).ready(function() {
        let lastcnt = 0;
        let cnt;
        let firstLoad = true; // Add a flag to track if it's the first load
        chkNewScan();

        function chkNewScan() {
            countTodayScan();
            setTimeout(chkNewScan, 500);
        }

        function countTodayScan() {
            $.ajax({
                url: '/countTodayScan',
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    cnt = data.rowcount;
                    if (!firstLoad && cnt > lastcnt) { // Only show the alert if it's not the first load and there's new data
                        showAlert();
                    }

                    lastcnt = cnt;
                    firstLoad = false; // Update the flag after the first load
                },
                error: function(result) {
                    console.log('Error in /countTodayScan:', result);
                }
            });
        }

        function showAlert() {
            $.ajax({
                url: '/loadData',
                type: 'GET',
                dataType: 'json',
                success: function(response){
                    Swal.fire({
                        title: "Success!",
                        text: "Time In Success",
                        icon: "success",
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true,
                        html: ` <p><strong>${response.response.id_no}-${response.response.name}</strong></p>
                                <p>${response.response.date} | ${response.response.time} | ${response.response.building_name}</p>
                                <div class="alert alert-warning" role="alert">
                                    <i class="fa-regular fa-circle-exclamation"></i> Notice:
                                </div>`
                    });
                },
                error: function(result) {
                    console.log('Error in /loadData:', result);
                }
            });
        }
    });
</script>
 
</body>
</html>
